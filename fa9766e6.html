<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title>Obelisk tutorial: Markdown preview with Reflex - Sridhar Ratnakumar</title><link crossorigin="use-credentials" href="static/manifest.webmanifest" rel="manifest" /><link href="static/favicon.jpeg" rel="icon" /><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.5/dist/semantic.min.css" rel="stylesheet" /><style type="text/css">body{background-color:#eeeeee !important;font-family:"DM Sans", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"DM Serif Text", sans-serif !important}body code, pre, tt, .monoFont{font-family:"DM Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body div#neuron-theme-default-teal .zettel-content h1{background-color:rgba(0,181,173,0.1)}body div#neuron-theme-default-teal span.zettel-link-container span.zettel-link a{color:#00b5ad}body div#neuron-theme-default-teal span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#00b5ad}body div#neuron-theme-default-teal .deemphasized:hover div.item a:hover{color:#00b5ad !important}body div#neuron-theme-default-teal div#footnotes{border-top-color:#00b5ad}body div#neuron-theme-default-brown .zettel-content h1{background-color:rgba(165,103,63,0.1)}body div#neuron-theme-default-brown span.zettel-link-container span.zettel-link a{color:#a5673f}body div#neuron-theme-default-brown span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#a5673f}body div#neuron-theme-default-brown .deemphasized:hover div.item a:hover{color:#a5673f !important}body div#neuron-theme-default-brown div#footnotes{border-top-color:#a5673f}body div#neuron-theme-default-red .zettel-content h1{background-color:rgba(219,40,40,0.1)}body div#neuron-theme-default-red span.zettel-link-container span.zettel-link a{color:#db2828}body div#neuron-theme-default-red span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#db2828}body div#neuron-theme-default-red .deemphasized:hover div.item a:hover{color:#db2828 !important}body div#neuron-theme-default-red div#footnotes{border-top-color:#db2828}body div#neuron-theme-default-orange .zettel-content h1{background-color:rgba(242,113,28,0.1)}body div#neuron-theme-default-orange span.zettel-link-container span.zettel-link a{color:#f2711c}body div#neuron-theme-default-orange span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#f2711c}body div#neuron-theme-default-orange .deemphasized:hover div.item a:hover{color:#f2711c !important}body div#neuron-theme-default-orange div#footnotes{border-top-color:#f2711c}body div#neuron-theme-default-yellow .zettel-content h1{background-color:rgba(251,189,8,0.1)}body div#neuron-theme-default-yellow span.zettel-link-container span.zettel-link a{color:#fbbd08}body div#neuron-theme-default-yellow span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#fbbd08}body div#neuron-theme-default-yellow .deemphasized:hover div.item a:hover{color:#fbbd08 !important}body div#neuron-theme-default-yellow div#footnotes{border-top-color:#fbbd08}body div#neuron-theme-default-olive .zettel-content h1{background-color:rgba(181,204,24,0.1)}body div#neuron-theme-default-olive span.zettel-link-container span.zettel-link a{color:#b5cc18}body div#neuron-theme-default-olive span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#b5cc18}body div#neuron-theme-default-olive .deemphasized:hover div.item a:hover{color:#b5cc18 !important}body div#neuron-theme-default-olive div#footnotes{border-top-color:#b5cc18}body div#neuron-theme-default-green .zettel-content h1{background-color:rgba(33,186,69,0.1)}body div#neuron-theme-default-green span.zettel-link-container span.zettel-link a{color:#21ba45}body div#neuron-theme-default-green span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#21ba45}body div#neuron-theme-default-green .deemphasized:hover div.item a:hover{color:#21ba45 !important}body div#neuron-theme-default-green div#footnotes{border-top-color:#21ba45}body div#neuron-theme-default-blue .zettel-content h1{background-color:rgba(33,133,208,0.1)}body div#neuron-theme-default-blue span.zettel-link-container span.zettel-link a{color:#2185d0}body div#neuron-theme-default-blue span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#2185d0}body div#neuron-theme-default-blue .deemphasized:hover div.item a:hover{color:#2185d0 !important}body div#neuron-theme-default-blue div#footnotes{border-top-color:#2185d0}body div#neuron-theme-default-violet .zettel-content h1{background-color:rgba(100,53,201,0.1)}body div#neuron-theme-default-violet span.zettel-link-container span.zettel-link a{color:#6435c9}body div#neuron-theme-default-violet span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#6435c9}body div#neuron-theme-default-violet .deemphasized:hover div.item a:hover{color:#6435c9 !important}body div#neuron-theme-default-violet div#footnotes{border-top-color:#6435c9}body div#neuron-theme-default-purple .zettel-content h1{background-color:rgba(163,51,200,0.1)}body div#neuron-theme-default-purple span.zettel-link-container span.zettel-link a{color:#a333c8}body div#neuron-theme-default-purple span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#a333c8}body div#neuron-theme-default-purple .deemphasized:hover div.item a:hover{color:#a333c8 !important}body div#neuron-theme-default-purple div#footnotes{border-top-color:#a333c8}body div#neuron-theme-default-pink .zettel-content h1{background-color:rgba(224,57,151,0.1)}body div#neuron-theme-default-pink span.zettel-link-container span.zettel-link a{color:#e03997}body div#neuron-theme-default-pink span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#e03997}body div#neuron-theme-default-pink .deemphasized:hover div.item a:hover{color:#e03997 !important}body div#neuron-theme-default-pink div#footnotes{border-top-color:#e03997}body div#neuron-theme-default-grey .zettel-content h1{background-color:rgba(118,118,118,0.1)}body div#neuron-theme-default-grey span.zettel-link-container span.zettel-link a{color:#767676}body div#neuron-theme-default-grey span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#767676}body div#neuron-theme-default-grey .deemphasized:hover div.item a:hover{color:#767676 !important}body div#neuron-theme-default-grey div#footnotes{border-top-color:#767676}body div#neuron-theme-default-black .zettel-content h1{background-color:rgba(27,28,29,0.1)}body div#neuron-theme-default-black span.zettel-link-container span.zettel-link a{color:#1b1c1d}body div#neuron-theme-default-black span.zettel-link-container span.zettel-link a:hover{color:#ffffff;background-color:#1b1c1d}body div#neuron-theme-default-black .deemphasized:hover div.item a:hover{color:#1b1c1d !important}body div#neuron-theme-default-black div#footnotes{border-top-color:#1b1c1d}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.84999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) span.zettel-link a, div.item a{color:#808080 !important}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .zettel-content div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f8f8f8}body div.zettel-view .zettel-content pre{padding:0.5em 0.5em 0.5em 0.5em;overflow:auto;max-width:100%}body div.zettel-view .zettel-content div.pandoc-code{margin-left:auto;margin-right:auto}body div.zettel-view .zettel-content div.pandoc-code pre{background-color:#f8f8f8}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .ui.label.zettel-tag a.tag-inner{color:#000000}body .ui.label.zettel-tag a.tag-inner a{color:#000000}body span.zettel-link-container span.zettel-link a{font-weight:bold;text-decoration:none}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.folgezettel::after{padding-left:0.29999em;content:"ᛦ"}body span.zettel-link-container.raw{border:solid 1px #ff0000}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}body nav.top-menu{padding-top:1em;padding-bottom:1em;justify-content:center;text-align:center}body nav.top-menu > *{padding-left:0px;padding-right:0px}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}</style><link href="https://fonts.googleapis.com/css?family=DM+Serif+Text|DM+Sans|DM+Mono&amp;display=swap" rel="stylesheet" /><meta content="Sridhar Ratnakumar" name="author" /><meta content="In this article, I’ll describe how to get a full-stack Haskell
application up and running. In particular, the app will render
user-entered Markdown text in real-time (the final version is hosted at
https://commonmark.srid.ca). Notably, our app will use Haskell even on
the frontend. This is made poss" name="description" /><link href="https://www.srid.ca/fa9766e6.html" rel="canonical" /><meta content="Obelisk tutorial: Markdown preview with Reflex" property="og:title" /><meta content="Sridhar Ratnakumar" property="og:site_name" /><meta content="article" property="og:type" /><script type="application/ld+json">[{"@context":"https://schema.org","itemListElement":[{"name":"Software","item":"https://www.srid.ca/2012302.html","@type":"ListItem","position":1},{"name":"Haskell","item":"https://www.srid.ca/2009703.html","@type":"ListItem","position":2},{"name":"Frontend in Haskell","item":"https://www.srid.ca/2012404.html","@type":"ListItem","position":3},{"name":"Reflex FRP","item":"https://www.srid.ca/2012405.html","@type":"ListItem","position":4},{"name":"Obelisk","item":"https://www.srid.ca/2012403.html","@type":"ListItem","position":5}],"@type":"BreadcrumbList"}]</script><style type="text/css">pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style></head><body><div class="ui fluid container" id="neuron-theme-default-teal"><nav class="top-menu"><div class="ui inverted compact neuron icon menu teal"><a class="left item" href="." title="Home"><i class="home icon"></i></a><a class="left item" href="search.html" title="Search Zettels"><i class="search icon"></i></a><a class="center item" href="https://github.com/srid/srid.ca/edit/master/fa9766e6.md" title="Edit this Zettel"><i class="edit icon"></i></a><a class="right item" href="z-index.html" title="All Zettels (z-index)"><i class="tree icon"></i></a></div></nav><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container cf"><span class="zettel-link"><a href="2012403.html">Obelisk</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container cf"><span class="zettel-link"><a href="2012405.html">Reflex FRP</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="2012404.html">Frontend in Haskell</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="2009703.html">Haskell</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link"><a href="2012302.html">Software</a></span></span></div></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div id="zettel-container-anchor" style="position: absolute; top: -24px; left: 0"></div><div class="zettel-view"><article class="ui raised attached segment zettel-content"><h1>Obelisk tutorial: Markdown preview with Reflex</h1><p>In this article, I’ll describe how to get a full-stack Haskell application up and running. In particular, the app will render user-entered Markdown text in real-time (the final version is hosted at <a class="" href="https://commonmark.srid.ca" id="" title="">https://commonmark.srid.ca</a>). Notably, our app will use Haskell even on the frontend. This is made possible by the <a class="" href="https://github.com/ghcjs/ghcjs" id="" title=""><strong>GHCJS</strong></a> compiler, that compiles Haskell code to JavaScript.</p><p>We will not work directly with GHCJS, however, and instead will use the <span class="zettel-link-container cf"><span class="zettel-link"><a href="2012405.html">Reflex FRP</a></span></span> library, through the excellent <span class="zettel-link-container cf"><span class="zettel-link"><a href="2012403.html">Obelisk</a></span></span> full-stack framework.</p><h2 class="" id="create-an-obelisk-project">Create an Obelisk project</h2><p>First and foremost, make sure you have <a class="" href="https://github.com/obsidiansystems/obelisk#installing-obelisk" id="" title="">Obelisk installed</a>, and then follow along.</p><p>Obelisk includes a command called <code class="" id="">ob</code> that can be used to initialize a project. We will also use git to keep track of changes:</p><div class="pandoc-code highlighted"><pre><code class="bash" id=""><span class="fu">mkdir</span><span class=""> MarkdownPreview</span>
<span class="bu">cd</span><span class=""> ./MarkdownPreview</span>
<span class="co"># Create an Obelisk project</span>
<span class="ex">ob</span><span class=""> init</span>
<span class="co"># Add to git</span>
<span class="fu">git</span><span class=""> init</span>
<span class="fu">git</span><span class=""> add .</span>
<span class="fu">git</span><span class=""> commit -m </span><span class="st">&quot;first commit&quot;</span>
</code></pre></div><p>This gives us a project layout with three Haskell packages: <code class="" id="">backend</code>, <code class="" id="">common</code> and <code class="" id="">frontend</code>. As the names indicate, <code class="" id="">frontend</code> contains the Haskell code that ultimate gets compiled to JavaScript. The <code class="" id="">common</code> package however contains code that is shared between the backend and the frontend. This is extremely useful for type sharing, which is impossible with something like Elm or PureScript (without explicit conversion).</p><div class="pandoc-code highlighted"><pre><code class="sh" id=""><span class="ex">backend</span>
<span class="ex">cabal.project</span>
<span class="ex">common</span>
<span class="ex">config</span>
<span class="ex">default.nix</span>
<span class="ex">frontend</span>
<span class="ex">shell.nix</span>
<span class="ex">static</span>
</code></pre></div><p>You will notice that Obelisk uses <span class="zettel-link-container cf"><span class="zettel-link"><a href="2017102.html">Nix</a></span></span> to build your project. The command <code class="" id="">ob run</code> (described below) will abstract over the Nix stuff, including any GHCi handling, so you do not have to deal directly with Nix except for overriding dependencies.</p><h2 class="" id="running-hello-world">Running hello world</h2><p>Now, it is time to run our app.</p><div class="pandoc-code highlighted"><pre><code class="sh" id=""><span class="ex">ob</span><span class=""> run</span>
</code></pre></div><p>This command may take a while to finish the very first time it is run, as it would need to download packages from the Nix caches. At the end you would expect to see: <code class="" id="">Frontend running on http://localhost:8000/</code>. Your obelisk app will be accessible at that URL.</p><h3 class="" id="interlude-ob-run-reloads-your-code">Interlude: <code class="" id="">ob run</code> reloads your code</h3><p>So what does this <code class="" id="">ob run</code> command do? Think of it as <code class="" id="">stack run</code> or <code class="" id="">cabal run</code> - but it also recompiles changed sources and reloads application. <code class="" id="">ob run</code> uses <a class="" href="https://github.com/ndmitchell/ghcid" id="" title="">ghcid</a> underneath, in combination with custom <code class="" id="">ghci</code> config to specify the modules to reload.</p><p>There is also <code class="" id="">ob repl</code> which gives you a GHCi repl for your project. As well as <code class="" id="">ob hoogle</code> providing a local Hoogle server for project and its dependencies.</p><h2 class="" id="add-commonmark-hs-dependency">Add commonmark-hs dependency</h2><p>Our application will use the Pure Haskell Markdown parser <a class="" href="https://github.com/jgm/commonmark-hs" id="" title="">commonmark-hs</a>, which is written by the author of Pandoc, who intends to <a class="" href="https://github.com/jgm/commonmark-hs/issues/1#issuecomment-395802118" id="" title="">migrate Pandoc over to it</a> eventually.</p><p>We will also use the latest version from Git, instead of Hackage. Some <a class="" href="https://nixos.org/nix/" id="" title="">Nix-fu</a> is helpful at this stage. But the main thing you need to know, in order to add a custom Haskell dependency, is the following general workflow:</p><ul><li>Clone the git repo under a subdirectory</li><li>“Pack” it using <code class="" id="">ob thunk</code></li><li>Load it in <code class="" id="">default.nix</code> using <code class="" id="">hackGet</code></li></ul><p>As briefly as possible, you would do this for commonmark-hs as follows:</p><div class="pandoc-code highlighted"><pre><code class="sh" id=""><span class="co"># Get the source</span>
<span class="fu">git</span><span class=""> clone https://github.com/jgm/commonmark-hs.git dep/commonmark-hs</span>
<span class="ex">...</span>
<span class="co"># Pack it</span>
<span class="ex">ob</span><span class=""> thunk pack dep/commonmark-hs</span>
<span class="ex">...</span>
</code></pre></div><p>Next, edit your <code class="" id="">default.nix</code> and:</p><ul><li>Add <code class="" id="">hackGet</code> and <code class="" id="">pkgs</code> as arguments to the <code class="" id="">project</code> if they don’t already exist</li><li>Use the packed thunk by calling <code class="" id="">hackGet</code></li><li>The git rep contains multiple Haskell packages; use <code class="" id="">commonmark</code> and <code class="" id="">commonmark-extensions</code></li></ul><p>Here’s how your <code class="" id="">default.nix</code> should look:</p><div class="pandoc-code highlighted"><pre><code class="nix" id=""><span class="ex">project</span><span class=""> ./. ({ pkgs, hackGet, ... }: </span><span class="kw">{</span>
<span class="">  </span><span class="ex">packages</span><span class=""> = let </span>
<span class="">    </span><span class="ex">commonmarkSrc</span><span class=""> = hackGet ./dep/commonmark-hs</span><span class="kw">;</span>
<span class="">  </span><span class="kw">in</span><span class=""> </span><span class="kw">{</span>
<span class="">    </span><span class="ex">commonmark</span><span class=""> = commonmarkSrc + </span><span class="st">&quot;/commonmark&quot;</span><span class="kw">;</span>
<span class="">    </span><span class="ex">commonmark-extensions</span><span class=""> = commonmarkSrc + </span><span class="st">&quot;/commonmark-extensions&quot;</span><span class="kw">;</span>
<span class="">  </span><span class="kw">}</span><span class="">;</span>
<span class="">  </span><span class="ex">...</span>
<span class="kw">}</span><span class="">)</span>
</code></pre></div><p>If you run <code class="" id="">ob run</code> at this point, it may complain about further missing dependencies. Let’s override each of them:</p><div class="pandoc-code highlighted"><pre><code class="sh" id=""><span class="fu">git</span><span class=""> clone https://github.com/jgm/emojis.git dep/emojis</span>
<span class="ex">ob</span><span class=""> thunk pack dep/emojis</span>
</code></pre></div><p>Go back to <code class="" id="">default.nix</code>, and add this new dependency to the <code class="" id="">packages</code> attribute:</p><div class="pandoc-code highlighted"><pre><code class="nix" id=""><span class="">    </span><span class="ex">...</span>
<span class="">    </span><span class="ex">emojis</span><span class=""> = hackGet ./dep/emojis</span><span class="kw">;</span>
</code></pre></div><p>As we will be using commonmark directly in the frontend, go ahead and add these to <code class="" id="">frontend.cabal</code> (under the library stanza):</p><div class="pandoc-code highlighted"><pre><code class="haskell" id=""><span class="co">-- frontend/frontend.cabal</span>
<span class="">               </span><span class="op">...</span>
<span class="">               , commonmark</span>
<span class="">               , commonmark</span><span class="op">-</span><span class="">extensions</span>
<span class="">  </span>
</code></pre></div><p>Restart <code class="" id="">ob run</code>, which should build the the new dependency before starting our app.</p><h3 class="" id="interlude-what-is-an-obelisk-thunk">Interlude: What is an Obelisk thunk?</h3><p>If you are familiar with <a class="" href="https://www.srid.ca/1948201.html#overriding-dependencies" id="" title="">Haskell overrides in Nix</a>, then think of the obelisk thunk mechanism as an abstraction on top. A “packed” thunk is essentially similar to Nix’s <code class="" id="">fetchGit</code> in that you specify the exact source revision of the dependency to use.</p><p>But a thunk can also be “unpacked”, using <code class="" id="">ob thunk unpack</code>, which – in addition to unpacking it as a git clone – has the effect of adding it to <code class="" id="">ob run</code> and <code class="" id="">ob repl</code> sessions. For example, you could unpack the above commonmark thunk using <code class="" id="">ob thunk unpack dep/commonmark-hs</code> and restart <code class="" id="">ob run</code>. Now, when you hack on <code class="" id="">./dep/commonmark-hs</code> and change its Haskell sources, <code class="" id="">ob run</code> will automatically reload the app using the modified commonmark-hs. See the Obelisk <a class="" href="https://github.com/obsidiansystems/obelisk/blob/master/ChangeLog.md#v0500---2020-02-07" id="" title="">ChangeLog</a> for details.</p><h2 class="" id="lets-add-a-textbox">Let’s add a textbox</h2><p>If you are unfamiliar with Reflex, checkout <a class="" href="https://reflex-frp.org/get-started" id="" title="">the official guide</a>. All our frontend code is defined in the <code class="" id="">frontend/src/Frontend.hs</code> file. With <code class="" id="">ob run</code> running by side, open that module and try changing a few things, like the title - and the app should update. Let’s add a textbox element where the user would write their Markdown text.</p><p>Somewhere in <code class="" id="">_frontend_body</code>, add the following:</p><div class="pandoc-code highlighted"><pre><code class="haskell" id=""><span class="ot">markdownText ::</span><span class=""> </span><span class="dt">Dynamic</span><span class=""> t </span><span class="dt">T.Text</span><span class=""> </span><span class="ot">&lt;-</span>
<span class="">  </span><span class="fu">fmap</span><span class=""> value </span><span class="op">$</span><span class=""> textAreaElement </span><span class="op">$</span>
<span class="">    def</span>
<span class="">    </span><span class="op">&amp;</span><span class=""> initialAttributes </span><span class="op">.~</span><span class=""> (</span><span class="st">&quot;style&quot;</span><span class=""> </span><span class="op">=:</span><span class=""> </span><span class="st">&quot;width:50%;height:15em;&quot;</span><span class="">)</span>
</code></pre></div><p><code class="" id="">markdownText</code> is a reflex Dynamic that holds the user-entered text.</p><h2 class="" id="parse-markdown">Parse Markdown</h2><p>Now it is time to actually use the commonmark library. Let’s import it:</p><div class="pandoc-code highlighted"><pre><code class="haskell" id=""><span class="kw">import</span><span class=""> </span><span class="kw">qualified</span><span class=""> </span><span class="dt">Commonmark</span><span class=""> </span><span class="kw">as</span><span class=""> </span><span class="dt">CM</span>

<span class="ot">renderMarkdown ::</span><span class=""> </span><span class="dt">T.Text</span><span class=""> </span><span class="ot">-&gt;</span><span class=""> </span><span class="dt">Either</span><span class=""> </span><span class="dt">CM.ParseError</span><span class=""> (</span><span class="dt">CM.Html</span><span class=""> ())</span>
<span class="">renderMarkdown </span><span class="ot">=</span>
<span class="">  CM.commonmark </span><span class="st">&quot;markdown&quot;</span>
</code></pre></div><p>The <code class="" id="">renderMarkdown</code> function will parse our Markdown and return the HTML representation of it. Calling <code class="" id="">show</code> on the Right value gets us the raw HTML.</p><h2 class="" id="render-to-html">Render to HTML</h2><p>Finally let’s plug everything together. We want to parse and render the resulting HTML every time the user changes the textbox. Reflex’s Dynamic automatically updates, so let’s use that.</p><div class="pandoc-code highlighted"><pre><code class="haskell" id=""><span class="">result </span><span class="ot">&lt;-</span><span class=""> eitherDyn </span><span class="op">$</span><span class=""> </span><span class="fu">fmap</span><span class=""> renderMarkdown markdownText</span>
<span class="">dyn_ </span><span class="op">$</span><span class=""> ffor result </span><span class="op">$</span><span class=""> \</span><span class="kw">case</span>
<span class="">  </span><span class="dt">Left</span><span class=""> err </span><span class="ot">-&gt;</span>
<span class="">    dyn_ </span><span class="op">$</span><span class=""> ffor err </span><span class="op">$</span><span class=""> \_ </span><span class="ot">-&gt;</span><span class=""> text </span><span class="st">&quot;Parse error&quot;</span>
<span class="">  </span><span class="dt">Right</span><span class=""> htmlVal </span><span class="ot">-&gt;</span>
<span class="">    prerender_ blank </span><span class="op">$</span><span class=""> void </span><span class="op">$</span><span class=""> elDynHtml&#39; </span><span class="st">&quot;div&quot;</span><span class=""> </span><span class="op">$</span><span class=""> T.pack </span><span class="op">.</span><span class=""> </span><span class="fu">show</span><span class=""> </span><span class="op">&lt;$&gt;</span><span class=""> htmlVal</span>
</code></pre></div><p>That’s all it takes! Now as you type the Markdown text, its live preview will automatically update next to the textbox.</p><p>You can even hack on commonmark-hs (see the Obelisk thunk interlude above), and have <code class="" id="">ob run</code> automatically reload when the library sources change. This is extremely handy if you want to play with the internals of the Markdown parser and see its live result in the browser.</p><h2 class="" id="further-resources">Further resources</h2><ul><li><p>Source code for this app on Github: <a class="" href="https://github.com/srid/MarkdownPreview" id="" title="">https://github.com/srid/MarkdownPreview</a></p></li><li><p>Fully built version of it running at: <a class="" href="https://commonmark.srid.ca/" id="" title="">https://commonmark.srid.ca/</a></p></li></ul><div class="date" title="Zettel creation date">Created on: <time datetime="2020-05-08">2020-05-08</time></div></article><nav class="ui bottom attached segment deemphasized"><div class="ui two column grid"><div class="column"><div class="ui header" title="Zettels that link here, but without branching">More backlinks</div><ul><li><span class="zettel-link-container"><span class="zettel-link"><a href="2009703.html">Haskell</a></span></span></li><li><span class="zettel-link-container"><span class="zettel-link"><a href="356bec10.html">Recently created zettels</a></span></span></li><li><span class="zettel-link-container"><span class="zettel-link"><a href=".">Sridhar Ratnakumar</a></span></span></li></ul></div><div class="column"><span class="ui right ribbon label zettel-tag" title="Tag"><a class="tag-inner" href="search.html?tag=timeline/haskell/cerveau" title="See all zettels tagged &#39;timeline/haskell/cerveau&#39;">timeline/haskell/cerveau</a></span><p></p><span class="ui right ribbon label zettel-tag" title="Tag"><a class="tag-inner" href="search.html?tag=reflex/obelisk" title="See all zettels tagged &#39;reflex/obelisk&#39;">reflex/obelisk</a></span><p></p></div></div></nav></div></div><script>if (window.scrollY == 0) { document.getElementById("zettel-container-anchor").scrollIntoView({behavior: "smooth", block: "start"}); }</script><div class="ui one column grid footer-version"><div class="center aligned column"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron" /></a></div></div></div></div></body></html>